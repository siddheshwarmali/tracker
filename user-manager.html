
<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive Board</title>
<!-- TW_BUILD_STAMP: 2026-01-16 15:28 IST (rename-db-fix) -->
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- SheetJS for Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    
    <!-- html2canvas for Report Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .modal { display: none; }
        .modal.open { display: flex; }
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 300ms; }
        .hidden-by-report { display: none !important; }
        
        .clickable-cell:hover { text-decoration: underline; cursor: pointer; color: #2563eb; font-weight: 600; }
        [contenteditable] { padding: 4px 8px; border-radius: 4px; transition: all 0.2s; border: 1px solid transparent; }
        [contenteditable]:hover { background-color: #f8fafc; border-color: #e2e8f0; }
        [contenteditable]:focus { outline: none; background-color: #eff6ff; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
        .l3-row:hover { background-color: #f8fafc; }
        .l3-row:hover .delete-btn { opacity: 1; pointer-events: auto; }
        .delete-btn { opacity: 0; transition: opacity 0.2s; }
    </style>

    <style>
      @keyframes ghspin { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }
      /* Hide Clear Storage button */
      button[onclick^="wsClearLocalStorage"], button[onclick="wsClearLocalStorage()"] { display:none !important; }
    </style>

<script>
  async function twJson(url, opt){
    const r = await fetch(url, Object.assign({headers:{'Accept':'application/json','Content-Type':'application/json'}}, opt||{}));
    const t = await r.text();
    let j={};
    try{ j=JSON.parse(t||'{}'); }catch{ j={error:t}; }
    if(!r.ok) throw new Error(j.error||j.message||t||('HTTP '+r.status));
    return j;
  }

  async function twInit(){
    const pill=document.getElementById('tw-userpill');
    const mgr=document.getElementById('tw-usermgr');
    const lo=document.getElementById('tw-logout');
    try{
      const me = await twJson('/api/auth/me');
      if(!me || !me.authenticated){
        const next=encodeURIComponent(location.pathname+location.search+location.hash);
        location.replace('/login.html?next='+next);
        return;
      }
      const role = me.role || 'viewer';
      document.body.classList.remove('role-admin','role-creator','role-viewer');
      document.body.classList.add('role-'+role);
      if(pill) pill.textContent = (me.userId||'User') + ' • ' + role;
      if(mgr) mgr.classList.toggle('hidden', role!=='admin');
      if(lo) lo.onclick = async ()=>{ try{ await twJson('/api/auth/logout', {method:'POST'});}catch(e){} location.href='/login.html'; };
    }catch(e){
      const next=encodeURIComponent(location.pathname+location.search+location.hash);
      location.replace('/login.html?next='+next);
    }
  }
  window.addEventListener('DOMContentLoaded', ()=>{ twInit(); });
</script>

</head>
<body class="bg-slate-50">
  <div class="max-w-5xl mx-auto p-6">
    <div class="flex items-start justify-between gap-4 flex-wrap">
      <div>
        <h1 class="text-xl font-bold text-slate-900">User Manager</h1>
        <p class="text-sm text-slate-600 mt-1">Admin can grant feature access per user: Build, Run, Executive Board, User Manager, Publish.</p>
      </div>
      <a href="./build.html" class="px-4 py-2 rounded-lg bg-slate-900 text-white text-sm">Back</a>
    </div>

    <div id="banner" class="hidden mt-4 p-3 rounded-lg text-sm"></div>

    <div class="mt-5 bg-white border rounded-xl p-4">
      <h2 class="font-semibold text-slate-900">Create / Update User</h2>
      <div class="grid md:grid-cols-3 gap-3 mt-3">
        <div>
          <label class="text-xs text-slate-600">User ID</label>
          <input id="newUserId" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="e.g. user1" />
        </div>
        <div>
          <label class="text-xs text-slate-600">Password</label>
          <input id="newPassword" type="password" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="Set/reset password" />
        </div>
        <div>
          <label class="text-xs text-slate-600">Role</label>
          <select id="newRole" class="w-full border rounded-lg px-3 py-2 text-sm bg-white">
            <option value="viewer">viewer</option>
            <option value="creator">creator</option>
            <option value="admin">admin</option>
          </select>
          <div class="text-[11px] text-slate-500 mt-1">Keep role viewer/creator and use permissions for Executive Board access.</div>
        </div>
      </div>

      <div class="mt-4">
        <label class="text-xs text-slate-600">Feature Access</label>
        <div class="mt-2 grid grid-cols-2 md:grid-cols-5 gap-2">
          <label class="flex items-center gap-2 text-xs"><input id="permBuild" type="checkbox" checked> Build</label>
          <label class="flex items-center gap-2 text-xs"><input id="permRun" type="checkbox" checked> Run</label>
          <label class="flex items-center gap-2 text-xs"><input id="permExec" type="checkbox"> Executive Board</label>
          <label class="flex items-center gap-2 text-xs"><input id="permUM" type="checkbox"> User Manager</label>
          <label class="flex items-center gap-2 text-xs"><input id="permPublish" type="checkbox"> Publish</label>
        </div>
      </div>

      <div class="mt-4 flex justify-end">
        <button id="btnAdd" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm">Add / Update</button>
      </div>
    </div>

    <div class="mt-5 bg-white border rounded-xl p-4">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <h2 class="font-semibold text-slate-900">Users</h2>
        <button id="btnReload" class="px-3 py-2 border rounded-lg text-sm">Reload</button>
      </div>
      <div class="overflow-auto mt-3">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left text-slate-600">
              <th class="py-2 pr-3">User</th>
              <th class="py-2 pr-3">Role</th>
              <th class="py-2 pr-3">Permissions</th>
              <th class="py-2 pr-3">Updated</th>
              <th class="py-2">Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="permModal" class="fixed inset-0 hidden items-center justify-center bg-black/50 z-50">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-lg p-5">
      <div class="flex items-center justify-between">
        <h3 class="font-semibold text-slate-900">Feature Access</h3>
        <button id="pmClose" class="text-slate-500 hover:text-slate-800">✕</button>
      </div>
      <p class="text-sm text-slate-600 mt-1">User: <span id="pmUser" class="font-mono"></span></p>
      <div class="mt-4 grid grid-cols-2 gap-3 text-sm">
        <label class="flex items-center gap-2"><input id="pmBuild" type="checkbox"> Build</label>
        <label class="flex items-center gap-2"><input id="pmRun" type="checkbox"> Run</label>
        <label class="flex items-center gap-2"><input id="pmExec" type="checkbox"> Executive Board</label>
        <label class="flex items-center gap-2"><input id="pmUM" type="checkbox"> User Manager</label>
        <label class="flex items-center gap-2"><input id="pmPub" type="checkbox"> Publish</label>
      </div>
      <div class="mt-5 flex justify-end gap-2">
        <button id="pmCancel" class="px-4 py-2 rounded-lg bg-slate-100 text-slate-800 text-sm">Cancel</button>
        <button id="pmSave" class="px-4 py-2 rounded-lg bg-indigo-600 text-white text-sm">Apply</button>
      </div>
    </div>
  </div>

<script>
  async function apiJson(url, opt){
    opt = opt || {};
    const r = await fetch(url, { headers:{'Accept':'application/json','Content-Type':'application/json'}, ...opt });
    const t = await r.text();
    let j={}; try{ j=JSON.parse(t||'{}'); }catch{ j={}; }
    if(!r.ok) throw new Error(j.error || `Request failed (${r.status})`);
    return j;
  }
  async function me(){
    const r = await fetch('/api/auth/me', { headers:{'Accept':'application/json'} });
    return r.json().catch(()=>({}));
  }
  function banner(kind, msg){
    const b=document.getElementById('banner');
    b.className = 'mt-4 p-3 rounded-lg text-sm ' + (kind==='ok' ? 'bg-green-50 border border-green-200 text-green-800' : 'bg-red-50 border border-red-200 text-red-800');
    b.textContent = msg;
    b.classList.remove('hidden');
    setTimeout(()=>b.classList.add('hidden'), 3500);
  }
  function permsToText(p){
    p=p||{};
    const on=[];
    if(p.build!==false) on.push('Build');
    if(p.run!==false) on.push('Run');
    if(p.executiveBoard) on.push('ExecBoard');
    if(p.userManager) on.push('UserMgr');
    if(p.publish) on.push('Publish');
    return on.join(', ') || '—';
  }

  // permissions modal
  let targetRow=null;
  function openPerms(userId, row){
    targetRow=row;
    document.getElementById('pmUser').textContent=userId;
    const p=row._perms||{};
    document.getElementById('pmBuild').checked = p.build!==false;
    document.getElementById('pmRun').checked = p.run!==false;
    document.getElementById('pmExec').checked = !!p.executiveBoard;
    document.getElementById('pmUM').checked = !!p.userManager;
    document.getElementById('pmPub').checked = !!p.publish;
    const m=document.getElementById('permModal');
    m.classList.remove('hidden'); m.classList.add('flex');
  }
  function closePerms(){
    const m=document.getElementById('permModal');
    m.classList.add('hidden'); m.classList.remove('flex');
  }
  document.getElementById('pmClose').onclick=closePerms;
  document.getElementById('pmCancel').onclick=closePerms;
  document.getElementById('pmSave').onclick=()=>{
    if(!targetRow) return;
    targetRow._perms = {
      build: document.getElementById('pmBuild').checked,
      run: document.getElementById('pmRun').checked,
      executiveBoard: document.getElementById('pmExec').checked,
      userManager: document.getElementById('pmUM').checked,
      publish: document.getElementById('pmPub').checked
    };
    closePerms();
    banner('ok','Permissions set (click Save to persist)');
  };

  async function load(){
    const m = await me();
    if(!m.authenticated) location.href='/login.html?next=' + encodeURIComponent('/user-manager.html');
    const data = await apiJson('/api/users', { method:'GET' });
    const tb=document.getElementById('tbody');
    tb.innerHTML='';
    (data.users||[]).forEach(u=>{
      const tr=document.createElement('tr');
      tr.className='border-t';
      tr._perms = u.permissions || { build:true, run:true, executiveBoard:false, userManager:false, publish:false };
      tr.innerHTML = `
        <td class='py-2 pr-3 font-mono'>${u.userId}</td>
        <td class='py-2 pr-3'><select class='border rounded px-2 py-1 text-xs' data-role>
          <option value='viewer'>viewer</option>
          <option value='creator'>creator</option>
          <option value='admin'>admin</option>
        </select></td>
        <td class='py-2 pr-3 text-xs text-slate-600' data-permtext></td>
        <td class='py-2 pr-3 text-xs text-slate-500'>${u.updatedAt||''}</td>
        <td class='py-2 flex gap-2 flex-wrap'>
          <button class='text-xs px-2 py-1 rounded bg-slate-50 border border-slate-200' data-perms>Permissions</button>
          <button class='text-xs px-2 py-1 rounded bg-indigo-50 border border-indigo-200 text-indigo-700' data-save>Save</button>
          <button class='text-xs px-2 py-1 rounded bg-slate-50 border border-slate-200' data-reset>Reset PW</button>
          <button class='text-xs px-2 py-1 rounded bg-red-50 border border-red-200 text-red-700' data-del>Delete</button>
        </td>`;
      tb.appendChild(tr);
      tr.querySelector('[data-role]').value = u.role || 'viewer';
      tr.querySelector('[data-permtext]').textContent = permsToText(tr._perms);
      tr.querySelector('[data-perms]').onclick=()=>openPerms(u.userId, tr);
      tr.querySelector('[data-save]').onclick=async()=>{
        try{
          await apiJson('/api/users', { method:'PUT', body: JSON.stringify({ userId:u.userId, role: tr.querySelector('[data-role]').value, permissions: tr._perms }) });
          banner('ok','Saved');
          await load();
        }catch(e){ banner('err', e.message||String(e)); }
      };
      tr.querySelector('[data-reset]').onclick=async()=>{
        const pw=prompt('New password for ' + u.userId);
        if(!pw) return;
        try{ await apiJson('/api/users', { method:'PUT', body: JSON.stringify({ userId:u.userId, password: pw }) }); banner('ok','Password updated'); }
        catch(e){ banner('err', e.message||String(e)); }
      };
      tr.querySelector('[data-del]').onclick=async()=>{
        if(!confirm('Delete ' + u.userId + '?')) return;
        try{ await apiJson('/api/users', { method:'DELETE', body: JSON.stringify({ userId:u.userId }) }); banner('ok','Deleted'); await load(); }
        catch(e){ banner('err', e.message||String(e)); }
      };
    });
  }

  document.getElementById('btnAdd').onclick=async()=>{
    try{
      const userId=document.getElementById('newUserId').value.trim();
      const password=document.getElementById('newPassword').value;
      const role=document.getElementById('newRole').value;
      if(!userId) throw new Error('User ID is required');
      if(!password) throw new Error('Password is required');
      const permissions={
        build: document.getElementById('permBuild').checked,
        run: document.getElementById('permRun').checked,
        executiveBoard: document.getElementById('permExec').checked,
        userManager: document.getElementById('permUM').checked,
        publish: document.getElementById('permPublish').checked
      };
      await apiJson('/api/users', { method:'POST', body: JSON.stringify({ userId, password, role, permissions }) });
      banner('ok','User saved');
      document.getElementById('newPassword').value='';
      await load();
    }catch(e){ banner('err', e.message||String(e)); }
  };
  document.getElementById('btnReload').onclick=load;
  load().catch(e=>banner('err', e.message||String(e)));
</script>
</body>
</html>
